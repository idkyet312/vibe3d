# Shadow Bias Controller for Vibe3D

## Overview
This system allows you to adjust shadow bias parameters in real-time using a Python Qt GUI while the Vibe3D application is running.

## Installation

### 1. Install Python Dependencies
```powershell
pip install -r requirements.txt
```

This will install PyQt6, which is required for the GUI.

### 2. Rebuild Vibe3D
The C++ application now includes nlohmann-json for reading the configuration file. You need to rebuild:

```powershell
# From the vibe3d directory
cmake --build build --config Release
```

This will automatically install nlohmann-json via vcpkg on the first build.

## Usage

### 1. Start the Shadow Bias Controller GUI
```powershell
python shadow_bias_controller.py
```

The GUI window will appear with sliders for all shadow bias parameters.

### 2. Run Vibe3D
```powershell
.\build\vibe3d.exe
```

### 3. Adjust Parameters in Real-Time
- **Sender-Side Bias (Pipeline)**:
  - `Depth Bias Constant`: Base depth offset applied during shadow map rendering
  - `Depth Bias Slope`: Additional bias based on surface slope relative to light
  
- **Receiver-Side Bias (Shader)**:
  - `Bias Multiplier`: Global multiplier for all receiver-side bias calculations
  
- **Cascade-Specific Receiver Bias**:
  - `Cascade 0-3`: Individual bias values for each shadow cascade (near to far)

### 4. See Changes Immediately
- The GUI automatically saves changes to `shadow_config.json` every 100ms
- The Vibe3D application reads this file every frame
- Changes take effect immediately in the running application

## How It Works

### Architecture
1. **Python Qt GUI** (`shadow_bias_controller.py`):
   - Provides sliders and spinboxes for all bias parameters
   - Automatically saves values to `shadow_config.json`
   - Updates happen every 100ms

2. **JSON Config File** (`shadow_config.json`):
   - Stores all bias parameters in JSON format
   - Acts as communication bridge between GUI and C++ app

3. **C++ Application**:
   - Reads `shadow_config.json` each frame before rendering shadows
   - Applies sender-side bias using `vkCmdSetDepthBias()`
   - Passes receiver-side bias to shaders via UBO

4. **GLSL Shaders** (`cube.frag`):
   - Receives bias values from ShadowUBO
   - Applies cascade-specific and multiplied bias during shadow sampling

### Parameters Explained

#### Sender-Side Bias (Applied during shadow map rendering)
- **Constant Factor**: Fixed offset added to depth values
  - Higher values = shadows pushed further from surfaces
  - Prevents self-shadowing but can cause "peter-panning" (detached shadows)
  
- **Slope Factor**: Adaptive offset based on surface angle
  - Higher values = more bias on steep slopes
  - Helps eliminate shadow acne on angled surfaces

#### Receiver-Side Bias (Applied during shadow sampling)
- **Multiplier**: Scales the base bias value
  - Fine-tunes the overall bias strength
  
- **Cascade Values**: Per-cascade bias amounts
  - Typically increase with distance (far cascades need more bias)
  - Cascade 0 = nearest, Cascade 3 = farthest

## Tips for Tuning

1. **Start with sender-side bias**: Adjust Constant and Slope factors first
2. **Use minimal receiver bias**: Start with Multiplier = 1.0
3. **Increase gradually**: Small increments prevent over-biasing
4. **Watch for artifacts**:
   - Self-shadowing = bias too low
   - Peter-panning (detached shadows) = bias too high
   - Missing shadows = bias way too high

## Default Values
```json
{
  "depthBiasConstant": 2.0,
  "depthBiasSlope": 2.25,
  "receiverBiasMultiplier": 1.0,
  "cascade0": 0.8,
  "cascade1": 1.5,
  "cascade2": 3.0,
  "cascade3": 6.0
}
```

## Troubleshooting

**GUI doesn't start:**
- Make sure PyQt6 is installed: `pip install PyQt6`

**Changes don't appear in Vibe3D:**
- Check that `shadow_config.json` exists in the vibe3d directory
- Make sure you rebuilt after adding nlohmann-json dependency

**Application crashes on startup:**
- Rebuild with: `cmake --build build --config Release --clean-first`

**Performance issues:**
- Reading the JSON file every frame has minimal overhead
- If needed, reduce read frequency in `updateShadowUBO()`

## File Structure
```
vibe3d/
├── shadow_bias_controller.py  # Qt GUI application
├── shadow_config.json          # Generated by GUI, read by C++ app
├── requirements.txt            # Python dependencies
├── src/vulkan/
│   ├── ForwardPlusRenderer.cpp # Reads JSON, applies bias
│   ├── ForwardPlusRenderer.h   # Shadow bias config struct
│   └── VulkanTypes.h           # ShadowUBO with bias fields
└── shaders/
    └── cube.frag               # Uses bias from UBO
```

## Advanced: Modifying the System

### Adding New Parameters
1. Add field to `ShadowBiasConfig` struct in `ForwardPlusRenderer.h`
2. Add field to `ShadowUBO` struct in `VulkanTypes.h` (if needed in shader)
3. Update `loadShadowBiasConfig()` in `ForwardPlusRenderer.cpp`
4. Update `updateShadowUBO()` to pass value to shader (if needed)
5. Add slider/spinbox in `shadow_bias_controller.py`
6. Update `bias_values` dict in Python GUI

### Reducing I/O Overhead
To read the config less frequently, modify `updateShadowUBO()`:
```cpp
static int frameCounter = 0;
if (frameCounter++ % 60 == 0) {  // Only read every 60 frames
    loadShadowBiasConfig();
}
```
